apiVersion: batch/v1
kind: Job
metadata:
  name: atharva-build-index
  namespace: atharva-ml
spec:
  template:
    spec:
      restartPolicy: Never
      containers:
      - name: index
        image: public.ecr.aws/docker/library/python:3.11-slim
        command: ["bash","-lc"]
        args:
          - |
            set -euo pipefail
            export HOME=/mnt/project
            VENV=/mnt/project/.venv-build
            ROOT=/mnt/project/atharva-dental-assistant/datasets/clinic
            OUT=/mnt/project/atharva-dental-assistant/artifacts/rag
            python -m venv "$VENV"
            . "$VENV/bin/activate"
            python -m pip install --upgrade pip
            # wheels-only stack for TF-IDF sparse build
            python -m pip install --only-binary=:all: \
              "numpy==1.26.4" "scipy==1.10.1" "scikit-learn==1.3.2" "joblib==1.3.2"
            # (dense mode optional; uncomment if you switch to --backend dense)
            # python -m pip install --only-binary=:all: sentence-transformers==2.7.0 faiss-cpu==1.7.4
            mkdir -p "$OUT"
            python /mnt/project/atharva-dental-assistant/rag/build_index.py \
              --root "$ROOT" \
              --outdir "$OUT" \
              --backend sparse
            ls -lah "$OUT" && (wc -c "$OUT"/meta.json || true)
        volumeMounts:
        - name: host
          mountPath: /mnt/project
      volumes:
      - name: host
        hostPath: { path: /mnt/project, type: Directory }


